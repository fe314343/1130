<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>試算表篩選與直式圖檔生成</title>
<!-- 載入 html-to-image 函式庫用於圖片生成 -->
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.12/dist/html-to-image.min.js"></script>

<!-- 載入 Noto Serif TC 字體以支援中文 -->
<!-- FIX: 增加 crossorigin="anonymous" 解決 html-to-image 讀取跨域 CSS 的 SecurityError -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght:400;500;700&display=swap" rel="stylesheet" crossorigin="anonymous">

<style>
body {
    font-family: 'Noto Serif TC', serif;
    background-color: #f0f0f0;
    margin: 0; padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}
.main-container {
    width: 90%; max-width: 1200px;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
#controls {
    display: flex; gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.control-group { display: flex; flex-direction: column; }
select, button {
    padding: 8px 10px;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #ccc;
    cursor: pointer;
    transition: background-color 0.3s;
}
.action-buttons {
    display: flex;
    gap: 15px;
    align-items: flex-end;
}
#resultsContainer {
    display: flex; gap: 20px;
    overflow-x: auto;
    padding: 10px 0;
    min-height: 500px;
}

/* =============================== */
/* ★ 直式圖檔生成區塊樣式 ★        */
/* =============================== */
.result-item {
    /* 確保寬高一致，符合直式圖檔比例 */
    width: 700px;
    height: 800px;
    min-width: 700px;
    min-height: 800px;
    position: relative;
    box-sizing: border-box;
    /* [修正] 移除邊框和圓角，讓輸出圖片乾淨利落，只包含內容 */
    border: none; 
    border-radius: 0;
    overflow: hidden; /* 防止內容預覽時溢出 */
}

/* 圖片完整顯示、不裁切、不變形 */
.result-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    position: absolute;
    top: 0; left: 0;
    z-index: 1;
}

/* 文字區塊（一定在圖片內） - 修正重點：使用 right 定位並調整尺寸 */
.content-block {
    position: absolute;
    z-index: 2;

    /* 調整定位以適應 vertical-rl (從右向左書寫) */
    top: 100px; /* 距離頂部 100px */
    right: 150px; /* 距離右側 150px */

    /* height 控制每一行文字的長度 (上下留白 100px*2=200px) */
    height: calc(100% - 100px); 
    /* width 控制總共能寫多少行 (左右預留空間) */
    width: calc(100% - 150px); 
    overflow: hidden; /* 確保超出範圍的文字被隱藏 */

    /* 直式書寫設定 */
    writing-mode: vertical-rl;
    text-orientation: upright;

    font-size: 20px;
    line-height: 1.4;

    white-space: pre-wrap;
    word-break: break-word;

    color: #333;
    /* 增加陰影讓文字在圖片上更清晰 */
    text-shadow: 0 0 3px rgba(255,255,255,0.9), 0 0 1px rgba(0,0,0,0.2); 
}

.download-button-wrapper {
    position: absolute;
    bottom: 10px;
    left: 10px;
    z-index: 5;
    writing-mode: horizontal-tb;
}

.btn-style {
    background-color: #4CAF50;
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
.btn-style:hover {
    background-color: #45a049;
}
#downloadAllBtn {
    background-color: #007bff;
    color: white;
    padding: 10px 15px;
}
#downloadAllBtn:hover {
    background-color: #0056b3;
}
#downloadAllBtn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .result-item {  /* 手機版適應 */
        width: 300px;
        height: 400px;
    }
}
</style>
</head>
<body>

<div class="main-container">
    <h1 style="text-align:center; margin-bottom:10px;">試算表篩選與直式圖檔生成</h1>

    <div id="controls">
        <div class="control-group">
            <label>選擇篩選欄位:</label>
            <select id="filterField">
                <option value="班期">班期</option>
                <option value="日期">日期</option>
                <option value="仙佛">仙佛</option>
                <option value="姓名">姓名</option>
                <option value="內容">內容</option>
                <option value="區域">區域</option>
            </select>
        </div>

        <div class="control-group">
            <label>選擇篩選值:</label>
            <select id="filterValueSelect" disabled>
                <option value="">請先選欄位</option>
            </select>
        </div>

        <div class="action-buttons">
            <button class="btn-style" onclick="applyFilter()">開始篩選</button>
            <button id="downloadAllBtn" class="btn-style" onclick="downloadAllImages()" disabled>下載所有 PNG</button>
        </div>
    </div>

    <div id="messageBox" style="margin-bottom: 10px;"></div>
    <div id="resultsContainer"><p>請選擇篩選條件後點擊開始篩選。</p></div>
</div>

<script>
// Google Apps Script URL，用於獲取試算表資料
const GS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzPsok1XF4E4PQEmckvxK3pY8GPI1GeTrceC5Oz5deQbDMvmgtJxd1e-WcIV4GjgxZV3g/exec';

const fieldMap = {
    "班期":"班期","日期":"日期","仙佛":"仙佛",
    "姓名":"姓名","內容":"內容","區域":"區域"
};

let globalSheetData = null;
let downloadableItems = [];
const messageBox = document.getElementById('messageBox');
const resultsContainer = document.getElementById('resultsContainer');
const downloadAllBtn = document.getElementById('downloadAllBtn');

/**
 * 顯示訊息給使用者
 * @param {string} msg 訊息內容
 * @param {boolean} isError 是否為錯誤訊息
 */
function displayMessage(msg, isError=false){
    messageBox.textContent = msg;
    messageBox.style.color = isError ? 'red':'green';
}
function hideMessage(){ messageBox.textContent=''; }

/**
 * 針對直式書寫強制斷行，防止內容超出單行垂直空間。
 * @param {string} text 原始文字
 * @param {number} maxCharsPerLine 每行最大字數
 * @returns {string} 處理後的帶有換行符的文字
 */
function forceVerticalLineBreak(text, maxCharsPerLine=18) { 
    if (!text) return '';
    const originalLines = text.split('\n');
    let processedLines = [];
    
    for (const line of originalLines) {
        if (line.length > maxCharsPerLine) {
            let tempLine = '';
            let lineChunks = [];
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (tempLine.length === maxCharsPerLine) {
                    lineChunks.push(tempLine);
                    tempLine = char;
                } else {
                    tempLine += char;
                }
            }
            if (tempLine.length > 0) lineChunks.push(tempLine);
            // 將過長的行以換行符串接
            processedLines.push(lineChunks.join('\n'));
        } else {
            processedLines.push(line);
        }
    }
    // 將所有行以換行符串接
    return processedLines.join('\n');
}

/**
 * 獲取試算表資料
 */
async function fetchSheetData(){
    const selectElement = document.getElementById('filterValueSelect');
    selectElement.innerHTML = '<option>載入中...</option>';
    selectElement.disabled = true;
    resultsContainer.innerHTML = '<p>資料載入中，請稍候...</p>';
    hideMessage();
    try {
        const res = await fetch(GS_SCRIPT_URL);
        const data = await res.json();
        globalSheetData = data;
        displayMessage('資料載入成功');
        return data;
    } catch (e) {
        console.error('Fetch error:', e);
        displayMessage('資料載入失敗',true);
        return null;
    }
}

/**
 * 根據選定的欄位填充篩選值下拉選單
 * @param {Array<Object>} data 試算表資料
 * @param {string} fieldKey 欄位名稱
 */
function populateFilterValues(data, fieldKey){
    const selectElement = document.getElementById('filterValueSelect');
    selectElement.innerHTML = '';
    
    if (!data || data.length === 0){
        selectElement.disabled=true;
        return;
    }

    const uniqueValues = new Set();
    data.forEach(row=>{
        const val = row[fieldKey];
        if(val) uniqueValues.add(val.toString().trim());
    });
    
    // 按中文排序
    const sorted = Array.from(uniqueValues).sort((a,b)=>a.localeCompare(b,'zh-TW'));

    const def = document.createElement('option');
    def.value=''; def.textContent='--- 請選擇 ---';
    selectElement.appendChild(def);

    sorted.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        selectElement.appendChild(o);
    });

    selectElement.disabled=false;
}

// 頁面載入後初始化
document.addEventListener('DOMContentLoaded', async()=>{
    if(!globalSheetData) await fetchSheetData();
    // 預設填充「班期」的篩選值
    populateFilterValues(globalSheetData, fieldMap["班期"]);
    
    // 監聽篩選欄位變更，並重新填充篩選值
    document.getElementById('filterField').addEventListener('change', (event)=>{ 
        populateFilterValues(globalSheetData, fieldMap[event.target.value]);
    });
});

/**
 * 執行篩選並生成圖片預覽
 */
function applyFilter(){
    const fieldSelect=document.getElementById('filterField');
    const valueSelect=document.getElementById('filterValueSelect');
    const filterKey=fieldMap[fieldSelect.value];
    const filterValue=valueSelect.value.trim().toLowerCase();

    resultsContainer.innerHTML='';
    downloadableItems=[];
    downloadAllBtn.disabled=true;
    hideMessage();

    if(!globalSheetData){ displayMessage('資料尚未載入',true); return; }
    if(!filterValue){ displayMessage('請選擇篩選值',true); return; }

    const filtered = globalSheetData.filter(row=>{
        const v=row[filterKey];
        return v && v.toString().trim().toLowerCase() === filterValue;
    });

    if(filtered.length===0){
        displayMessage('找不到符合資料');
        resultsContainer.innerHTML=`<p>無資料：${valueSelect.value}</p>`;
        return;
    }

    displayMessage(`找到 ${filtered.length} 筆資料`);
    downloadAllBtn.disabled=false;

    filtered.forEach((row, index)=>{
        const itemDiv = document.createElement("div");
        itemDiv.className = "result-item";
        itemDiv.id = `item-${index}`; // 給予ID方便截圖

        /* 圖片（背景圖，保持不裁切、不變形） */
        const img = document.createElement("img");
        img.className = "result-img";
        // FIX: 增加 crossorigin="anonymous" 解決 html-to-image 讀取跨域圖片的 SecurityError
        img.setAttribute('crossOrigin', 'anonymous'); 
        
        // 替換為您的圖片 URL
        img.src = "https://chy0205.github.io/1110/1130.png";
        img.onerror = () => { console.error('Image failed to load'); img.src = 'https://placehold.co/700x800/eeeeee/333333?text=背景圖載入失敗'; };
        itemDiv.appendChild(img);

        /* 文字內容區塊 */
        const contentBlock = document.createElement("div");
        contentBlock.className = "content-block";

        let finalContent = "\n";
        const name = row["姓名"] || "";
        const content = row["內容"] || ""; // 獲取原始內容

        // 日期
        if(row["日期"]) finalContent += ` ${row["日期"]}\n`;

        // 仙佛與班期
        if(row["仙佛"] || row["班期"]){
            let text = "　";
            if(row["仙佛"]) text += row["仙佛"];
            if(row["班期"]) text += `於${row["班期"]}`;
            finalContent += text + "\n";
        }

        const indent6 = "　　　　　　"; // 6 個全形空白
        
        // 姓名（蔡廣生|） - 位於第一行的前綴
        const namePrefix = name ? `${indent6}${name}|` : "";

        // 調整：調用時使用 17 作為最大字數
        const maxCharsPerLine = 23; 
        const wrappedContent = forceVerticalLineBreak(content, maxCharsPerLine);
        const lines = wrappedContent.split("\n");

        // 計算後續行的縮排字元數：6 + 姓名長度 + 1 (分隔符號)
        const totalIndent = 6 + name.length + 1;
        const contentIndentString = "　".repeat(totalIndent);

        let formatted = "";
        lines.forEach((line, i)=>{
            if(i===0) {
                // 第一行文字內容不需要額外的 contentIndentString，因為 namePrefix 已經提供了開頭縮排
                formatted += line; 
            }
            else {
                // 第二行及以後的內容需要換行並縮排對齊第一行姓名之後的位置
                formatted += '\n' + contentIndentString + line;
            }
        });

        finalContent += namePrefix + formatted;

        /* 區域 - 修正邏輯：根據最後一行內容字數決定是否換行 */
        if(row["區域"]){
            let prefix = '　'; // 預設：同行並加一個空白間隔
            
            // 取得實際內容的最後一行 (lines 陣列中最後一個元素)
            const lastContentLine = lines[lines.length - 1] || '';
            const lastLineLength = lastContentLine.length; // 該行的實際字數

            // 判斷邏輯：如果最後一行字數少於 10 個字，則換到新的一行（新的垂直列）
            if (lastLineLength > 1) { 
                // 換到新的一行，並加入標準的內容縮排，使其與前面內容對齊
                prefix = '\n' + contentIndentString; 
            } else {
                // 如果字數夠多（>= 10），則同行接續，用一個全形空白隔開
                prefix = '';
            }

            // 使用模板字串和半形括號
            finalContent += `${prefix}（${row["區域"]}）`; 
        }

        contentBlock.textContent = finalContent;
        itemDiv.appendChild(contentBlock);

        /* 下載按鈕 */
        const btnWrapper = document.createElement("div");
        btnWrapper.className="download-button-wrapper";
        const btn=document.createElement("button");
        btn.className="btn-style";
        btn.textContent="下載 PNG";

        const filename=`${row["姓名"]||"未知"}-${row["區域"]||"未知"}`;
        btn.onclick=()=>generateImage(itemDiv, filename);

        btnWrapper.appendChild(btn);
        itemDiv.appendChild(btnWrapper);

        resultsContainer.appendChild(itemDiv);
        downloadableItems.push({element:itemDiv, filename});
    });
}

/**
 * 截圖並下載單個圖片
 * @param {HTMLElement} element 要截圖的 DOM 元素
 * @param {string} filename 儲存檔名
 * @param {function(boolean):void} callback 下載完成後的回調函數
 */
async function generateImage(element, filename, callback=()=>{}){
    // 截圖前暫時隱藏下載按鈕
    const hideBtn = element.querySelector('.download-button-wrapper');
    if(hideBtn) hideBtn.style.display='none';

    try {
        // 使用 htmlToImage 轉換為 PNG 圖片資料 URL
        const dataUrl = await htmlToImage.toPng(element);
        const a=document.createElement('a');
        a.href=dataUrl;
        a.download=filename + ".png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        callback(true);
    } catch(e){
        console.error("生成圖片失敗:", e);
        // 顯示錯誤訊息
        displayMessage(`生成圖片失敗: ${e.message}`, true); 
        callback(false);
    } finally {
        // 截圖後恢復顯示下載按鈕
        if(hideBtn) hideBtn.style.display='block';
    }
}

/**
 * 下載所有生成的圖片
 */
async function downloadAllImages(){
    if(downloadableItems.length===0) return;

    downloadAllBtn.disabled=true;
    displayMessage("開始下載...");

    const delay = ms => new Promise(r=>setTimeout(r, ms));

    // 依序下載所有項目，並在每次下載間隔 500ms
    for(let i=0;i<downloadableItems.length;i++){
        const item = downloadableItems[i];
        displayMessage(`下載中：${item.filename} (${i+1}/${downloadableItems.length})`);
        
        await new Promise(resolve=>{
            // generateImage 內會執行下載
            generateImage(item.element, item.filename, ()=>resolve());
        });
        
        // 加入延遲，防止瀏覽器阻擋連續下載
        await delay(500); 
    }

    displayMessage("全部下載完成！");
    downloadAllBtn.disabled=false;
}
</script>
</body>
</html>
