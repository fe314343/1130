<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<!-- 設定 viewport 確保網頁在移動裝置上能正確縮放 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>聖訓小卡生成</title>

<!-- 載入 html-to-image 函式庫，用於將 HTML 元素轉換為圖片 (DOM 截圖) -->
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.12/dist/html-to-image.min.js"></script>
<!-- 載入 JSZip 函式庫，用於將多個圖片打包成一個 ZIP 壓縮檔 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- 載入 FileSaver.js 函式庫，用於在瀏覽器端觸發檔案下載流程 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<!-- 引入 Google Fonts 的 Noto Serif TC (思源宋體 繁體中文)，作為標楷體的備用字體 -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght%40400%3B700&display=swap" rel="stylesheet" crossorigin="anonymous">

<style>
/* ---------------------------------------------------- */
/* ★ 全域樣式設定 (Global Styles) ★                        */
/* ---------------------------------------------------- */
body {
    /* 字體設定：優先使用使用者系統內建的「標楷體」或其常見別名，以符合書寫風格。
       如果都找不到，則使用思源宋體 (Noto Serif TC)。 */
    font-family: "標楷體", "DFKai-SB", "KaiTi", 'Noto Serif TC', serif;
    background-color: #f0f0f0; /* 頁面背景色 */
    margin: 0; padding: 20px; /* 頁面邊距 */
    display: flex; /* 使用 Flexbox 進行佈局 */
    flex-direction: column; /* 垂直排列子元素 */
    align-items: center; /* 水平居中對齊 */
    min-height: 100vh; /* 確保內容區塊至少佔滿整個視窗高度 */
}
.main-container {
    width: 90%; max-width: 1200px; /* 設定最大寬度並居中 */
    padding: 20px;
    background: #fff; /* 白色背景 */
    border-radius: 12px; /* 圓角邊框 */
    box-shadow: 0 4px 15px rgba(0,0,0,0.15); /* 陰影效果 */
}
#controls {
    display: flex; gap: 15px; /* 控制項間距 */
    margin-bottom: 15px;
    flex-wrap: wrap; /* 允許控制項在小螢幕上換行 */
}
.control-group { display: flex; flex-direction: column; } /* 控制項分組，垂直排列 Label 和 Select */
/* 下拉選單和按鈕的基礎樣式 */
select, button {
    padding: 8px 10px;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #ccc;
    cursor: pointer;
    transition: background-color 0.3s;
    font-family: inherit; /* 繼承 body 的字體設定，確保中文字體一致 */
}
.action-buttons {
    display: flex;
    gap: 15px;
    align-items: flex-end; /* 底部對齊，讓按鈕與下拉選單的底部對齊 */
}
#resultsContainer {
    display: flex; gap: 20px;
    overflow-x: auto; /* 允許水平滾動查看所有生成的圖片預覽 */
    padding: 10px 0;
    min-height: 500px; /* 確保結果容器有足夠高度，避免內容跳動 */
}

/* ---------------------------------------------------- */
/* ★ 直式圖檔生成區塊樣式 (截圖目標: .result-item) ★        */
/* ---------------------------------------------------- */
.result-item {
    /* 固定的圖片尺寸：720x1280 像素，常見的直式手機螢幕比例，這是截圖的邊界 */
    width: 720px;
    height: 1280px;
    min-width: 720px;
    min-height: 1280px;
    position: relative; /* 設置相對定位，以容納絕對定位的文字和圖片 */
    box-sizing: border-box; /* 確保 padding/border 不會增加總尺寸 */
    border: none; 
    border-radius: 0;
    overflow: hidden; /* 確保內容在截圖邊界內 */
    background-color: #fff; /* 預設白色背景，防止圖片載入失敗時透明 */
}

/* 背景圖片樣式 */
.result-img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* 確保圖片不變形地適應容器 */
    position: absolute;
    top: 0; left: 0;
    z-index: 1; /* 位於下層，作為背景 */
}

/* 文字內容區塊 - 實作直式書寫 */
.content-block {
    position: absolute;
    z-index: 2; /* 位於上層，覆蓋背景圖片 */

    /* 調整定位：直式書寫從右側開始，稍微從邊緣內縮 */
    top: 40px; 
    right: 5px; 

    height: calc(100% - 50px); /* 垂直方向的長度（即字行的高度） */
    width: calc(100% - 10px); /* 水平方向的寬度（即字行數量的空間） */
    overflow: hidden; /* 防止文字溢出容器 */

    /* ★ 核心：設定直式書寫模式（從右向左，即列從右邊開始排） */
    writing-mode: vertical-rl;
    /* 確保所有字元（包括數字和英文字母）都保持直立，不旋轉 90 度 */
    text-orientation: upright;
    
    font-family: "標楷體", "DFKai-SB", "KaiTi", 'Noto Serif TC', serif;
    font-size: 30px; /* 基礎字體大小 */
    line-height: 1.2; /* 行距 (控制字行之間的垂直距離) */
    letter-spacing: 13px; /* 基礎字元間距 (控制字元間的水平距離) */
    white-space: pre-wrap; /* 允許文字保留原始換行符 (\n) 且自動換行 */
    word-break: break-word; /* 允許長單詞或連續字符在任何位置斷開 */

    color: #333;
    /* 輕微的文字陰影，讓文字在複雜背景圖片上更清晰，增強可讀性 */
    text-shadow: 0 0 3px rgba(255,255,255,0.9), 0 0 1px rgba(0,0,0,0.2); 
}

/* 區域文字的樣式：字體較小 */
.small-text {
    font-size: 20px;
    font-family: "標楷體", "DFKai-SB", "KaiTi", 'Noto Serif TC', serif;
    white-space: nowrap;
}

/* 專門用於對齊的 span 元素，需要設定 display: inline-block 才能應用 letter-spacing */
/* 這是實現標題兩行文字「長度一致」對齊的核心 CSS 元素 */
.content-block span {
    display: inline-block;
}

/* 下載按鈕的樣式和定位 */
.download-button-wrapper {
    position: absolute;
    bottom: 10px;
    left: 10px;
    z-index: 5; /* 確保按鈕在最上層 */
    writing-mode: horizontal-tb; /* 確保按鈕文字是橫式，不被直式書寫影響 */
}

/* (其他按鈕樣式保持不變...) */
.btn-style {
    background-color: #4CAF50; /* 按鈕基本顏色 */
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
.btn-style:hover {
    background-color: #45a049;
}
/* 下載全部按鈕的特殊樣式 */
#downloadAllBtn {
    background-color: #007bff;
    color: white;
    padding: 10px 15px;
}
#downloadAllBtn:hover {
    background-color: #0056b3;
}
#downloadAllBtn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}

/* 媒體查詢：適應手機螢幕，將預覽圖縮小 */
@media (max-width: 768px) {
    .result-item {
        width: 300px;
        height: 400px;
    }
}
</style>
</head>
<body>

<div class="main-container">
    <h1 style="text-align:center; margin-bottom:10px;">聖訓小卡生成</h1>

    <div id="controls">
        <div class="control-group">
            <label>選擇欄位:</label>
            <select id="filterField">
                <option value="班期">班期</option>
                <option value="日期">日期</option>
                <option value="仙佛">仙佛</option>
                <option value="姓名">姓名</option>
                <option value="內容">內容</option>
                <option value="區域">區域</option>
            </select>
        </div>

        <div class="control-group">
            <label>選擇值:</label>
            <!-- 預設禁用，等資料載入後啟用 -->
            <select id="filterValueSelect" disabled>
                <option value="">請先選欄位</option>
            </select>
        </div>

        <div class="action-buttons">
            <button class="btn-style" onclick="applyFilter()">開始篩選</button>
            <!-- 下載所有圖片為 ZIP 檔案的按鈕 -->
            <button id="downloadAllBtn" class="btn-style" onclick="downloadAllImages()" disabled>下載為 ZIP</button>
        </div>
    </div>

    <!-- 用於顯示系統訊息或錯誤提示 -->
    <div id="messageBox" style="margin-bottom: 10px;"></div>
    <!-- 圖片結果預覽的容器 -->
    <div id="resultsContainer"><p>請選擇篩選條件後點擊開始篩選。</p></div>
</div>

<script>
// ----------------------------------------------------
// ★ JavaScript 核心邏輯 ★
// ----------------------------------------------------

// Google Apps Script 部署的 URL，用於從 Google Sheets 獲取 JSON 資料
const GS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzPsok1XF4E4PQEmckvxK3pY8GPI1GeTrceC5Oz5deQbDMvmgtJxd1e-WcIV4GjgxZV3g/exec';
// 背景圖片的原始網址
const BG_IMAGE_URL = 'https://chy0205.github.io/1110/1201.png';

// 欄位名稱映射表，用於從下拉選單的值對應到 JSON 資料的鍵
const fieldMap = {
    "班期":"班期","日期":"日期","仙佛":"仙佛",
    "姓名":"姓名","內容":"內容","區域":"區域"
};

let globalSheetData = null; // 儲存從試算表載入的所有資料
let downloadableItems = []; // 儲存所有待下載的圖片元素和檔名資訊
// 儲存已轉換為 Base64 的背景圖，避免重複下載
let cachedBgBase64 = null; 

const messageBox = document.getElementById('messageBox');
const resultsContainer = document.getElementById('resultsContainer');
const downloadAllBtn = document.getElementById('downloadAllBtn');

// ★ 字元對齊和間距相關常數 - 這是直式標題對齊的核心 ★
const CHAR_FONT_SIZE_PX = 30; // 內容區塊的字體大小 (用於計算視覺空間)
const BASE_LETTER_SPACING_PX = 13; // CSS 中 .content-block 設定的基礎字距
// 一個字元在直式書寫中佔用的視覺空間 (字體大小 + 基礎字距)
const VISUAL_CHAR_UNIT_PX = CHAR_FONT_SIZE_PX + BASE_LETTER_SPACING_PX; // 44px
const ALIGN_MIN_TARGET_LEN = 15; // 當兩行標題都太短時，預設對齊的最小目標長度


/**
 * 顯示訊息給使用者
 */
function displayMessage(msg, isError=false){
    messageBox.textContent = msg;
    messageBox.style.color = isError ? 'red':'green';
}
function hideMessage(){ messageBox.textContent=''; }

/**
 * 預先載入背景圖片並轉換為 Base64 DataURL。
 * 這能解決大部分手機或瀏覽器在截圖時因為 CORS (跨域) 問題導致背景空白的情況。
 */
async function preloadBackground() {
    if (cachedBgBase64) return cachedBgBase64;
    
    try {
        console.log("開始下載背景圖並轉換...");
        // 使用 fetch 抓取圖片
        const response = await fetch(BG_IMAGE_URL, { mode: 'cors' });
        if (!response.ok) throw new Error("Network response was not ok");
        
        const blob = await response.blob();
        
        // 將 Blob 轉為 Base64 字串
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                cachedBgBase64 = reader.result;
                console.log("背景圖轉換成功");
                resolve(reader.result);
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    } catch (e) {
        console.warn("無法轉換背景圖為 Base64 (可能是跨域限制)，將退回使用原始網址。", e);
        // 如果轉換失敗，退回使用原始網址，至少讓瀏覽器嘗試載入
        return BG_IMAGE_URL;
    }
}

/**
 * 針對直式書寫強制斷行，防止內容超出單行垂直空間 (圖片的高度)。
 */
function forceVerticalLineBreak(text, maxCharsPerLine=21) { 
    if (!text) return '';
    const originalLines = text.split('\n');
    let processedLines = [];
    
    for (const line of originalLines) {
        if (line.length > maxCharsPerLine) {
            let tempLine = '';
            let lineChunks = [];
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (tempLine.length === maxCharsPerLine) {
                    lineChunks.push(tempLine);
                    tempLine = char;
                } else {
                    tempLine += char;
                }
            }
            if (tempLine.length > 0) lineChunks.push(tempLine);
            processedLines.push(lineChunks.join('\n'));
        } else {
            processedLines.push(line);
        }
    }
    return processedLines.join('\n');
}

/**
 * 根據最長行調整字元間距，以達到視覺上的垂直對齊 (長度一致)。
 */
function generateAlignedSpan(text, targetLen) {
    if (!text || text.trim().length === 0) return text;
    const currentLen = text.length;
    if (currentLen >= targetLen) return text;

    const neededCharUnits = targetLen - currentLen;
    const totalExtraSpaceNeededPx = neededCharUnits * VISUAL_CHAR_UNIT_PX;
    const numGaps = currentLen - 1;
    let finalSpan = text;

    if (numGaps > 0) {
        const extraSpacingPerGap = totalExtraSpaceNeededPx / numGaps;
        const totalSpacing = BASE_LETTER_SPACING_PX + extraSpacingPerGap;
        finalSpan = `<span style="letter-spacing:${totalSpacing.toFixed(2)}px;">${text}</span>`;
    } else if (currentLen === 1) {
        finalSpan = text + '　'.repeat(neededCharUnits); 
    }
    
    return finalSpan;
}

/**
 * 異步獲取試算表資料，並更新 UI 狀態
 */
async function fetchSheetData(){
    const selectElement = document.getElementById('filterValueSelect');
    selectElement.innerHTML = '<option>載入中...</option>';
    selectElement.disabled = true;
    resultsContainer.innerHTML = '<p>資料載入中，請稍候...</p>';
    hideMessage();
    try {
        const res = await fetch(GS_SCRIPT_URL);
        const data = await res.json();
        globalSheetData = data;
        displayMessage('資料載入成功');
        return data;
    } catch (e) {
        console.error('Fetch error:', e);
        displayMessage('資料載入失敗',true);
        return null;
    }
}

/**
 * 根據選定的欄位填充篩選值下拉選單
 */
function populateFilterValues(data, fieldKey){
    const selectElement = document.getElementById('filterValueSelect');
    selectElement.innerHTML = '';
    
    if (!data || data.length === 0){
        selectElement.disabled=true;
        return;
    }

    const uniqueValues = new Set();
    data.forEach(row=>{
        const val = row[fieldKey];
        if(val) uniqueValues.add(val.toString().trim());
    });
    
    const sorted = Array.from(uniqueValues).sort((a,b)=>a.localeCompare(b,'zh-TW'));

    const def = document.createElement('option');
    def.value=''; def.textContent='--- 請選擇 ---';
    selectElement.appendChild(def);

    sorted.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        selectElement.appendChild(o);
    });

    selectElement.disabled=false;
}

// 頁面載入後初始化
document.addEventListener('DOMContentLoaded', async()=>{
    // 預先偷偷開始載入背景圖，加快稍後的速度
    preloadBackground(); 

    const initializeData = async () => {
        if(!globalSheetData) await fetchSheetData();
        if (globalSheetData) {
            populateFilterValues(globalSheetData, fieldMap["班期"]);
        }
    };
    await initializeData();
    
    document.getElementById('filterField').addEventListener('change', (event)=>{ 
        populateFilterValues(globalSheetData, fieldMap[event.target.value]);
    });
});

/**
 * 執行篩選並生成圖片預覽
 * 注意：這裡改為 async 函式，因為要等待圖片轉換
 */
async function applyFilter(){
    const fieldSelect=document.getElementById('filterField');
    const valueSelect=document.getElementById('filterValueSelect');
    const filterKey=fieldMap[fieldSelect.value];
    const filterValue=valueSelect.value.trim().toLowerCase();

    resultsContainer.innerHTML='';
    downloadableItems=[];
    downloadAllBtn.disabled=true;
    hideMessage();

    if(!globalSheetData){ displayMessage('資料尚未載入',true); return; }
    if(!filterValue){ displayMessage('請選擇篩選值',true); return; }

    const filtered = globalSheetData.filter(row=>{
        const v=row[filterKey];
        return v && v.toString().trim().toLowerCase() === filterValue; 
    });

    if(filtered.length===0){
        displayMessage('找不到符合資料');
        resultsContainer.innerHTML=`<p>無資料：${valueSelect.value}</p>`;
        return;
    }

    displayMessage('正在準備圖片資源...');
    
    // ★ 關鍵步驟：確保背景圖片已轉換為 Base64
    const bgSrc = await preloadBackground();

    displayMessage(`找到 ${filtered.length} 筆資料`);
    downloadAllBtn.disabled=false;

    filtered.forEach((row, index)=>{
        const itemDiv = document.createElement("div");
        itemDiv.className = "result-item";
        itemDiv.id = `item-${index}`;

        /* 圖片（背景圖） */
        const img = document.createElement("img");
        img.className = "result-img";
        img.setAttribute('crossOrigin', 'anonymous'); // 保持這個，雙重保險
        
        // ★ 使用轉換後的 Base64 資料，解決跨域不顯示問題
        img.src = bgSrc;

        img.onerror = () => { 
            console.error('Image failed to load in DOM'); 
            img.src = 'https://placehold.co/720x1280/eeeeee/333333?text=背景圖載入失敗'; 
        };
        itemDiv.appendChild(img);

        /* 文字內容區塊 */
        const contentBlock = document.createElement("div");
        contentBlock.className = "content-block";

        // --- 文字處理邏輯 (保持不變) ---
        let dateLineText = '';
        if(row["日期"]) {
            dateLineText = `${row["日期"]}`; 
        }
        
        let deityCourseLineText = '';
        if(row["仙佛"] || row["班期"]){
            let text = ""; 
            if(row["仙佛"]) text += row["仙佛"];
            if(row["班期"]) text += `慈悲於${row["班期"]}`;
            deityCourseLineText = text;
        }

        const finalMaxLen = Math.max(dateLineText.length, deityCourseLineText.length);
        const targetLen = finalMaxLen > 1 ? finalMaxLen : ALIGN_MIN_TARGET_LEN;

        let finalContentString = "\n"; 
        finalContentString += generateAlignedSpan(dateLineText, targetLen) + '\n';
        finalContentString += generateAlignedSpan(deityCourseLineText, targetLen) + '\n';

        const name = row["姓名"] || "";
        const content = row["內容"] || ""; 
        const FIXED_TOTAL_INDENT = 7; 
        const nameAndSeparatorLength = name.length + 1; 
        const requiredPrefixSpaces = Math.max(0, FIXED_TOTAL_INDENT - nameAndSeparatorLength);
        const indentString = "　".repeat(requiredPrefixSpaces); 
        const namePrefix = name ? `${indentString}${name}|` : "";

        const maxCharsPerLine = 19; 
        const wrappedContent = forceVerticalLineBreak(content, maxCharsPerLine);
        const lines = wrappedContent.split("\n"); 

        const totalIndent = FIXED_TOTAL_INDENT;
        const contentIndentString = "　".repeat(totalIndent);

        let formatted = "";
        lines.forEach((line, i)=>{
            if(i===0) { formatted += line; }
            else { formatted += '\n' + contentIndentString + line; }
        });

        let finalHTML = finalContentString + namePrefix + formatted;

        if(row["區域"]){
            const lastContentLine = lines[lines.length - 1] || '';
            const lastLineLength = lastContentLine.length; 
            const maxCharsForSameLine = 14; 
            let prefix = ''; 
            if (lastLineLength > maxCharsForSameLine) { prefix = '\n' + contentIndentString; } 
            else { prefix = ''; }
            const areaHtml = `<span class="small-text">（${row["區域"]}）</span>`;
            finalHTML += `${prefix}${areaHtml}`; 
        }

        contentBlock.innerHTML = finalHTML;
        itemDiv.appendChild(contentBlock);
        // --- 文字處理結束 ---

        /* 單一下載按鈕 */
        const btnWrapper = document.createElement("div");
        btnWrapper.className="download-button-wrapper";
        const btn=document.createElement("button");
        btn.className="btn-style";
        btn.textContent="下載 PNG";

        const filename=`${row["姓名"]||"未知"}-${row["區域"]||"未知"}`;
        btn.onclick=()=>generateImage(itemDiv, filename);

        btnWrapper.appendChild(btn);
        itemDiv.appendChild(btnWrapper);

        resultsContainer.appendChild(itemDiv);
        downloadableItems.push({element:itemDiv, filename});
    });
}

/**
 * 截圖並下載單個圖片 (用於單一按鈕)
 */
async function generateImage(element, filename, callback=()=>{}){
    const hideBtn = element.querySelector('.download-button-wrapper');
    if(hideBtn) hideBtn.style.display='none';

    try {
        // 設定更嚴格的截圖參數
        const options = {
            quality: 0.95,
            useCORS: true, // 強制開啟 CORS 支援
            allowTaint: true, // 允許污染 (搭配 Base64 使用效果佳)
            backgroundColor: '#ffffff' // 設定白色背景作為保底
        };

        const blob = await htmlToImage.toBlob(element, options);
        
        if (blob) {
            saveAs(blob, filename + ".png");
        } else {
            throw new Error('無法生成圖片 Blob');
        }
        
        callback();
    } catch(e){
        console.error("生成圖片失敗:", e);
        displayMessage(`生成圖片失敗: ${e.message}`, true); 
        callback();
    } finally {
        if(hideBtn) hideBtn.style.display='block';
    }
}

/**
 * 下載所有生成的圖片，並將其打包成 ZIP 檔案
 */
async function downloadAllImages(){
    if(downloadableItems.length===0) return;

    downloadAllBtn.disabled=true;
    displayMessage("開始打包 ZIP 檔案，請稍候...");

    const zip = new JSZip();
    const folder = zip.folder("generated_images"); 
    const delay = ms => new Promise(r=>setTimeout(r, ms));

    try {
        for(let i=0;i<downloadableItems.length;i++){
            const item = downloadableItems[i];
            const hideBtn = item.element.querySelector('.download-button-wrapper');
            if(hideBtn) hideBtn.style.display='none';

            displayMessage(`處理中：${item.filename}.png (${i+1}/${downloadableItems.length})`);
            
            // 同步更新下載全部的選項
            const options = {
                quality: 0.95,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            };

            const imageBlob = await htmlToImage.toBlob(item.element, options);
            folder.file(`${item.filename}.png`, imageBlob);

            if(hideBtn) hideBtn.style.display='block';
            await delay(500); 
        }

        displayMessage("正在壓縮檔案...");
        const zipBlob = await zip.generateAsync({type: "blob"});
        saveAs(zipBlob, "試算表圖檔輸出.zip");
        displayMessage("ZIP 檔案下載完成！");
    } catch(e) {
        console.error("生成 ZIP 失敗:", e);
        displayMessage(`生成 ZIP 失敗: ${e.message}`, true);
    } finally {
        downloadAllBtn.disabled=false;
    }
}
</script>
</body>
</html>

